<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Fusee.Examples.Simple.Blazor</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="Fusee.Examples.Simple.Blazor.styles.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />


</head>

<body>
    <div id="app">
    </div>


    <script src="_framework/blazor.webassembly.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>


    <script>

        window.init = (instance) => {
            window.theInstance = instance;
            window.requestAnimationFrame(gameLoop);

            var cvs = document.getElementById("canvas");
            window.addEventListener("keydown", (evt) => { evt.preventDefault(); DotNet.invokeMethod('Fusee.Engine.Imp.Graphics.WebAsm', 'OnKeyDown', evt.keyCode); });
            window.addEventListener("keyup", (evt) => { evt.preventDefault(); DotNet.invokeMethod('Fusee.Engine.Imp.Graphics.WebAsm', 'OnKeyUp', evt.keyCode); });


            cvs.addEventListener("mousedown", (evt) => DotNet.invokeMethod('Fusee.Engine.Imp.Graphics.WebAsm', 'OnMouseDown', evt.button));
            cvs.addEventListener("mouseup", (evt) => DotNet.invokeMethod('Fusee.Engine.Imp.Graphics.WebAsm', 'OnMouseUp', evt.button));
            cvs.addEventListener("mousemove", (evt) => DotNet.invokeMethod('Fusee.Engine.Imp.Graphics.WebAsm', 'OnMouseMove', evt.offsetX, evt.offsetY));
            cvs.addEventListener("wheel", (evt) => {
                evt.preventDefault();
                DotNet.invokeMethod('Fusee.Engine.Imp.Graphics.WebAsm', 'OnMouseWheel', evt.deltaY);
            });
        };

        function customTexImage2D(params, source) {
            const gl2 = document.getElementsByTagName("canvas")[0].getContext('webgl2');

            // extract setting params from array
            const paramPtr = Blazor.platform.getArrayEntryPtr(params, 0, 4);
            const paramLength = Blazor.platform.getArrayLength(params);
            var parameter = new Int32Array(Module.HEAPU8.buffer, paramPtr, paramLength);

            const target = parameter[0];
            const level = parameter[1];
            const internalformat = parameter[2];
            const width = parameter[3];
            const height = parameter[4];
            const border = parameter[5];
            const format = parameter[6];
            const type = parameter[7];

            const dataPtr = Blazor.platform.getArrayEntryPtr(source, 0, 2);
            const length = Blazor.platform.getArrayLength(source);
            const data = new Uint8Array(Module.HEAPU8.buffer, dataPtr, length);
            gl2.texImage2D(target, level, internalformat, width, height, border, format, type, data);
        }

        function customBufferData(target, data, usage) {

            const gl2 = document.getElementsByTagName("canvas")[0].getContext('webgl2');

            if (target == gl2.ARRAY_BUFFER) {
                const dataPtr = Blazor.platform.getArrayEntryPtr(data, 0, 8);
                const length = Blazor.platform.getArrayLength(data);
                var floats = new Float32Array(Module.HEAPU8.buffer, dataPtr, length);
                gl2.bufferData(target, floats, usage);
            }
            else if (target == gl2.ELEMENT_ARRAY_BUFFER) {
                const dataPtr = Blazor.platform.getArrayEntryPtr(data, 0, 2);
                const length = Blazor.platform.getArrayLength(data);
                var ints = new Uint16Array(Module.HEAPU8.buffer, dataPtr, length);
                gl2.bufferData(target, ints, usage);
            } else {
                console.error("Error: Buffer type not found:", target);
            }
        }

        function gameLoop(timeStamp) {
            window.requestAnimationFrame(gameLoop);
            theInstance.invokeMethod('Loop', timeStamp);
        }

        function addEventListener(reference, propertyIdentifier, val) {
            console.log("AddEventListener", reference, propertyIdentifier, val);
            reference.addEventListener(propertyIdentifier, val);
        }

        function setObjectProperty(reference, propertyIdentifier, val) {
            reference[propertyIdentifier] = val;
        }

        function setAttribute(reference, propertyIdentifier, val) {
            reference.setAttribute(propertyIdentifier, val);
        }

        function getObjectProperty(reference, property) {
            return reference[property];
        }

        function getObject(objectToRetrive) {
            if (objectToRetrive === 'window')
                return window;
            if (objectToRetrive === 'document')
                return window.document;
            return document.getElementsByTagName(objectToRetrive)[0];
        }

    </script>

</body>

</html>
