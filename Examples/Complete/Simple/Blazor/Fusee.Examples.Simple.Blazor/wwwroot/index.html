<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Fusee.Examples.Simple.Blazor</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="Fusee.Examples.Simple.Blazor.styles.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />


</head>

<body>
    <div id="app">
    </div>


    <script src="_framework/blazor.webassembly.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>


    <script>
        function HelloWorld() {
            //console.log("Hallo Welt");
        }
        window.init = (instance) => {
            window.theInstance = instance;
            window.requestAnimationFrame(gameLoop);
        };

        function get_intern_context() {
            console.log("get_context_intern");
            return document.getElementsByTagName("canvas")[0].getContext('webgl2', {
                alpha: false,
                antialias: true,
                premultipliedAlpha: false,
                depth: true              
            });
        }

        function custom_fill_texture(target, level, internalformat, width, height, border, format, type, source) {
            const gl2 = document.getElementsByTagName("canvas")[0].getContext('webgl2');
            console.log("custom_fill_texture", target, level, internalformat, width, height, border, format, type, source);

            const data = new Uint8Array(source);
            gl2.texImage2D(target, level, internalformat, width, height, border, format, type, data);

        }

        function custom_fill_buffer(target, data, usage) {
            //console.log("Custom fill Buffer data", target, data, usage);

            const gl = document.getElementsByTagName("canvas")[0].getContext('webgl2', {
                alpha: false,
                antialias: true,
                premultipliedAlpha: false,
                depth: true
            });

            if (target == gl.ARRAY_BUFFER) {
                const dataPtr = Blazor.platform.getArrayEntryPtr(data, 0, 8);
                const length = Blazor.platform.getArrayLength(data);
                var floats = new Float32Array(Module.HEAPU8.buffer, dataPtr, length);
                gl.bufferData(target, floats, usage);
            }
            else if (target == gl.ELEMENT_ARRAY_BUFFER) {
                const dataPtr = Blazor.platform.getArrayEntryPtr(data, 0, 2);
                const length = Blazor.platform.getArrayLength(data);
                var ints = new Uint16Array(Module.HEAPU8.buffer, dataPtr, length);
                gl.bufferData(target, ints, usage);
            } else {
                //console.log("Error: Buffer type not found:", target);
                //console.log("gl.ARRAY_BUFFER is ", gl.ARRAY_BUFFER);
                //console.log("gl.ELEMENT_BUFFER is ", gl.ELEMENT_ARRAY_BUFFER);
            }
        }

        function gameLoop(timeStamp) {
            window.requestAnimationFrame(gameLoop);
            theInstance.invokeMethod('Loop', timeStamp);
        }

        function SetObjectProperty(reference, propertyIdentifier, val) {
            //console.log("SetObjectProperty", reference, propertyIdentifier, val);
            //console.log("Before", reference[propertyIdentifier]);
            reference[propertyIdentifier] = val;
            //console.log("After", reference[propertyIdentifier]);
        }
        function GetObjectProperty(reference, property) {
            //console.log("GetObjectProperty", reference, property);
            //console.log("Res", reference[property])
            return reference[property];
        }
        function GetObject(objectToRetrive) {
            //console.log("GetObject", objectToRetrive);

            if (objectToRetrive === 'window')
                return window;

            if (objectToRetrive === 'document')
                return window.document;

            return document.getElementsByTagName(objectToRetrive)[0];
        }
    </script>

</body>

</html>
